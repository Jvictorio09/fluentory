<script>
/**
 * Theme Toggle System
 * Manages light/dark theme switching across all pages
 * Default: dark mode (as per requirements)
 */

(function() {
    'use strict';

    const THEME_STORAGE_KEY = 'fluentory-theme';
    const THEME_LIGHT = 'light';
    const THEME_DARK = 'dark';

    /**
     * Detect system preference
     */
    function getSystemPreference() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
            return THEME_LIGHT;
        }
        return THEME_DARK;
    }

    /**
     * Get current theme from localStorage or default to system preference, fallback to dark
     */
    function getTheme() {
        const stored = localStorage.getItem(THEME_STORAGE_KEY);
        if (stored === THEME_LIGHT || stored === THEME_DARK) {
            return stored;
        }
        // No stored preference - respect system preference, default to dark
        return getSystemPreference();
    }

    /**
     * Save theme preference to localStorage
     */
    function saveTheme(theme) {
        localStorage.setItem(THEME_STORAGE_KEY, theme);
    }

    /**
     * Apply theme to document
     */
    function applyTheme(theme) {
        const html = document.documentElement;
        const body = document.body;
        
        // Remove both theme classes first (html always exists)
        html.classList.remove('light-theme', 'dark-theme');
        
        // Only manipulate body if it exists
        if (body) {
            body.classList.remove('theme-light', 'theme-dark');
        }
        
        if (theme === THEME_DARK) {
            html.setAttribute('data-theme', 'dark');
            html.classList.add('dark-theme');
            if (body) {
                body.classList.add('theme-dark');
            }
        } else {
            html.setAttribute('data-theme', 'light');
            html.classList.add('light-theme');
            if (body) {
                body.classList.add('theme-light');
            }
        }
        
        // Update toggle button icons (only if DOM is ready)
        if (body) {
            updateToggleIcons(theme);
        }
    }

    /**
     * Update toggle button icons based on current theme
     */
    function updateToggleIcons(theme) {
        const lightIcon = document.querySelector('.theme-icon-light');
        const darkIcon = document.querySelector('.theme-icon-dark');
        const toggleBtn = document.getElementById('theme-toggle');
        
        if (lightIcon && darkIcon) {
            if (theme === THEME_DARK) {
                // Show sun icon (to switch to light)
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
                if (toggleBtn) {
                    toggleBtn.setAttribute('aria-label', 'Switch to light mode');
                }
            } else {
                // Show moon icon (to switch to dark)
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
                if (toggleBtn) {
                    toggleBtn.setAttribute('aria-label', 'Switch to dark mode');
                }
            }
        }
    }

    /**
     * Toggle between light and dark themes
     */
    function toggleTheme() {
        const currentTheme = getTheme();
        const newTheme = currentTheme === THEME_LIGHT ? THEME_DARK : THEME_LIGHT;
        saveTheme(newTheme);
        applyTheme(newTheme);
    }

    /**
     * Initialize theme on page load
     */
    function initTheme() {
        const theme = getTheme();
        applyTheme(theme);
    }

    /**
     * Set up event listeners
     */
    function setupEventListeners() {
        // Theme toggle button
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', toggleTheme);
        }

        // Listen for theme changes from other tabs/windows
        window.addEventListener('storage', function(e) {
            if (e.key === THEME_STORAGE_KEY) {
                const newTheme = e.newValue || getSystemPreference();
                applyTheme(newTheme);
            }
        });

        // Listen for system preference changes (only if user hasn't set a preference)
        if (window.matchMedia) {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: light)');
            mediaQuery.addEventListener('change', function(e) {
                // Only apply system preference if user hasn't set a manual preference
                const stored = localStorage.getItem(THEME_STORAGE_KEY);
                if (!stored) {
                    const systemTheme = e.matches ? THEME_LIGHT : THEME_DARK;
                    applyTheme(systemTheme);
                }
            });
        }
    }

    /**
     * Initialize when DOM is ready
     */
    function init() {
        // Apply theme immediately to prevent flash (before DOM ready)
        // This sets data-theme on html element (body might not exist yet)
        initTheme();
        
        // Set up event listeners when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // Re-apply theme now that body exists (to set body classes)
                const theme = getTheme();
                applyTheme(theme);
                setupEventListeners();
                updateToggleIcons(theme);
            });
        } else {
            // DOM already ready - body exists, so applyTheme will set body classes
            const theme = getTheme();
            applyTheme(theme);
            setupEventListeners();
            updateToggleIcons(theme);
        }
    }

    // Start initialization immediately (runs before DOM is ready to prevent flash)
    init();

    // Export for external use if needed
    window.FluentoryTheme = {
        toggle: toggleTheme,
        setTheme: function(theme) {
            if (theme === THEME_LIGHT || theme === THEME_DARK) {
                saveTheme(theme);
                applyTheme(theme);
            }
        },
        getTheme: getTheme
    };
})();
</script>


