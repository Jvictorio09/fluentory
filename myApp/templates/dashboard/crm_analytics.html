{% extends 'dashboard/base.html' %}

{% block content %}
<div class="w-full max-w-[1600px] mx-auto">
    <!-- Header -->
    <div class="mb-8 sm:mb-10 animate-fade-in-up stagger-1">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div>
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extralight text-white mb-3 tracking-[-0.02em]">
                    CRM Analytics
                </h1>
                <p class="text-base sm:text-lg text-white/70 font-light">Lead conversion metrics and performance</p>
            </div>
            <a href="{% url 'dashboard:leads' %}" class="inline-flex items-center gap-2 bg-[#254346]/70 border border-white/10 text-white px-6 py-3 rounded-xl no-underline font-medium hover:bg-[#254346]/90 hover:border-[#82C293]/40 transition-all duration-300 hover:scale-105">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Leads</span>
            </a>
        </div>
        
        <!-- Filters -->
        <div class="flex flex-wrap gap-4 mb-6 animate-fade-in-up stagger-2">
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-white/60 mb-2 font-medium">Date From</label>
                    <input type="date" name="date_from" value="{{ date_from }}" class="px-4 py-2.5 rounded-xl border border-white/10 bg-[#254346]/70 backdrop-blur-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#82C293]/40 focus:border-[#82C293]/50 transition-all duration-300">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-wider text-white/60 mb-2 font-medium">Date To</label>
                    <input type="date" name="date_to" value="{{ date_to }}" class="px-4 py-2.5 rounded-xl border border-white/10 bg-[#254346]/70 backdrop-blur-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#82C293]/40 focus:border-[#82C293]/50 transition-all duration-300">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-wider text-white/60 mb-2 font-medium">Owner</label>
                    <select name="owner" class="px-4 py-2.5 rounded-xl border border-white/10 bg-[#254346]/70 backdrop-blur-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#82C293]/40 focus:border-[#82C293]/50 transition-all duration-300">
                        <option value="">All Owners</option>
                        {% for owner in owners %}
                        <option value="{{ owner.id }}" {% if owner_filter == owner.id|stringformat:"s" %}selected{% endif %}>{{ owner.get_full_name|default:owner.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-wider text-white/60 mb-2 font-medium">Source</label>
                    <select name="source" class="px-4 py-2.5 rounded-xl border border-white/10 bg-[#254346]/70 backdrop-blur-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#82C293]/40 focus:border-[#82C293]/50 transition-all duration-300">
                        <option value="">All Sources</option>
                        <option value="facebook" {% if source_filter == 'facebook' %}selected{% endif %}>Facebook</option>
                        <option value="instagram" {% if source_filter == 'instagram' %}selected{% endif %}>Instagram</option>
                        <option value="referral" {% if source_filter == 'referral' %}selected{% endif %}>Referral</option>
                        <option value="event" {% if source_filter == 'event' %}selected{% endif %}>Event</option>
                        <option value="website" {% if source_filter == 'website' %}selected{% endif %}>Website</option>
                        <option value="gift" {% if source_filter == 'gift' %}selected{% endif %}>Gift</option>
                        <option value="other" {% if source_filter == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
                <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-[#00655F] to-[#82C293] text-white rounded-xl hover:shadow-[0_8px_25px_rgba(130,194,147,0.4)] transition-all duration-300 font-medium hover:scale-105 group">
                    <i class="fas fa-filter mr-2 transition-transform duration-300 group-hover:scale-110"></i>Apply Filters
                </button>
                <a href="{% url 'dashboard:crm_analytics' %}" class="px-6 py-2.5 bg-[#254346]/70 border border-white/10 text-white rounded-xl hover:bg-[#254346]/90 hover:border-[#82C293]/40 transition-all duration-300 font-medium hover:scale-105">
                    <i class="fas fa-times mr-2"></i>Clear
                </a>
            </form>
        </div>
    </div>
    
    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-[#04363a]/70 backdrop-blur-xl rounded-2xl border border-white/10 shadow-[0_15px_40px_rgba(0,0,0,0.3)] p-6 animate-fade-in-up stagger-2">
            <div class="text-sm font-medium text-white/60 mb-2">Total Leads</div>
            <div class="text-3xl font-bold text-white">{{ total_leads }}</div>
        </div>
        <div class="bg-[#04363a]/70 backdrop-blur-xl rounded-2xl border border-white/10 shadow-[0_15px_40px_rgba(0,0,0,0.3)] p-6 animate-fade-in-up stagger-3">
            <div class="text-sm font-medium text-white/60 mb-2">Enrolled Leads</div>
            <div class="text-3xl font-bold text-[#259d78]">{{ enrolled_leads }}</div>
        </div>
        <div class="bg-[#04363a]/70 backdrop-blur-xl rounded-2xl border border-white/10 shadow-[0_15px_40px_rgba(0,0,0,0.3)] p-6 animate-fade-in-up stagger-4">
            <div class="text-sm font-medium text-white/60 mb-2">Conversion Rate</div>
            <div class="text-3xl font-bold text-[#82C293]">{{ conversion_rate|floatformat:1 }}%</div>
        </div>
    </div>
    
    <!-- Leads by Status -->
    <div class="bg-[#04363a]/70 backdrop-blur-xl rounded-2xl border border-white/10 shadow-[0_15px_40px_rgba(0,0,0,0.3)] p-8 mb-6 animate-fade-in-up stagger-3">
        <h2 class="text-xl font-semibold text-white mb-6">Leads by Status</h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-[#254346]/50 border-b border-white/10">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-white">Status</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-white">Count</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-white">Percentage</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {% for status_data in leads_by_status %}
                    <tr class="hover:bg-[#82C293]/5 transition-all duration-300">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 rounded-full text-xs font-medium 
                                {% if status_data.status == 'enrolled' %}bg-[#259d78]/20 text-[#259d78] border border-[#259d78]/30
                                {% elif status_data.status == 'new' %}bg-[#f8da03]/20 text-[#f8da03] border border-[#f8da03]/40
                                {% elif status_data.status == 'contacted' %}bg-[#82C293]/20 text-[#82C293] border border-[#82C293]/30
                                {% else %}bg-[#254346]/70 text-white/70 border border-white/20{% endif %}">
                                {{ status_data.status|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white/70">{{ status_data.count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white/70">
                            {% widthratio status_data.count total_leads 100 %}%
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="px-6 py-12 text-center text-white/60">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Source Performance -->
    <div class="bg-[#04363a]/70 backdrop-blur-xl rounded-2xl border border-white/10 shadow-[0_15px_40px_rgba(0,0,0,0.3)] p-8 animate-fade-in-up stagger-4">
        <h2 class="text-xl font-semibold text-white mb-6">Source Performance</h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-[#254346]/50 border-b border-white/10">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-white">Source</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-white">Lead Count</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-white">Enrolled</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-white">Conversion Rate</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {% for source in source_performance %}
                    <tr class="hover:bg-[#82C293]/5 transition-all duration-300">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-[#82C293]/20 text-[#82C293] border border-[#82C293]/30">
                                {{ source.source }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white/70">{{ source.lead_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white/70">{{ source.enrolled_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-white">{{ source.conversion_rate|floatformat:1 }}%</span>
                                <div class="flex-1 bg-[#254346]/70 rounded-full h-2 max-w-24">
                                    <div class="bg-[#82C293] h-2 rounded-full" style="width: {% if source.conversion_rate > 100 %}100{% else %}{{ source.conversion_rate }}{% endif %}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-white/60">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

