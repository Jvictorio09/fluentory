{% extends 'student/base.html' %}

{% block content %}
<div class="flex flex-col lg:flex-row h-[calc(100vh-4rem)] w-full overflow-hidden">
    <!-- Left Sidebar: Learning Path -->
    <aside class="hidden lg:block w-80 bg-[#04363a]/90 backdrop-blur-xl border-r border-white/10 overflow-y-auto shrink-0">
        <div class="p-6">
            <h3 class="text-lg font-medium text-white mb-4">Learning Path</h3>
            
            <div class="space-y-4">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-check-circle text-[#82C293]"></i>
                        <span class="text-sm font-medium text-white">Module 1: Foundations</span>
                    </div>
                    <div class="ml-6 space-y-2">
                        <div class="flex items-center gap-2 text-sm text-white">
                            <i class="fas fa-check text-[#82C293] text-xs"></i>
                            <span>Lesson 1: Introduction</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-white">
                            <i class="fas fa-check text-[#82C293] text-xs"></i>
                            <span>Lesson 2: Core Concepts</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm font-medium text-white bg-[#254346]/50 border border-[#82C293]/30 px-3 py-2 rounded-lg">
                            <i class="fas fa-play text-[#82C293] text-xs"></i>
                            <span>Lesson 3: Data Visualization Basics</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-lock text-white/40"></i>
                        <span class="text-sm font-medium text-white/60">Module 2: Advanced Topics</span>
                    </div>
                    <div class="ml-6 space-y-2">
                        <div class="flex items-center gap-2 text-sm text-white/60">
                            <i class="fas fa-lock text-white/40 text-xs"></i>
                            <span>Lesson 4: Advanced Analysis</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-white/60">
                            <i class="fas fa-lock text-white/40 text-xs"></i>
                            <span>Quiz: Module 2 Assessment</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 p-4 rounded-xl bg-[#254346]/50 border border-white/10">
                <div class="text-xs uppercase tracking-wider text-white/60 mb-2">Next Milestone</div>
                <div class="text-sm font-medium text-white">Quiz unlocks after Lesson 3</div>
            </div>
        </div>
    </aside>
    
    <!-- Center: Content -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <!-- Video Player -->
        <div class="bg-deep-charcoal aspect-video relative w-full shrink-0">
            <div class="absolute inset-0 flex items-center justify-center">
                <button class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-white/20 backdrop-blur-md border border-white/30 grid place-items-center hover:bg-white/30 transition">
                    <i class="fas fa-play text-white text-xl sm:text-2xl ml-1"></i>
                </button>
            </div>
        </div>
        
        <!-- Lesson Content -->
        <div class="flex-1 overflow-y-auto bg-[#000000] min-h-0 xl:border-r xl:border-white/10">
            <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 w-full">
                <div class="mb-4 sm:mb-6">
                    <div class="text-xs uppercase tracking-wider text-white/60 mb-2">Lesson 3</div>
                    <h2 class="text-2xl sm:text-3xl font-light text-white mb-3 sm:mb-4">Data Visualization Basics</h2>
                    <p class="text-base sm:text-lg text-white/80 leading-relaxed">
                        Learn how to create compelling visualizations that tell a story with your data. This lesson covers the fundamentals of choosing the right chart type, color theory, and best practices for data presentation.
                    </p>
                </div>
                
                <div class="prose max-w-none text-white/80">
                    <p>Data visualization is the graphical representation of information and data. By using visual elements like charts, graphs, and maps, data visualization tools provide an accessible way to see and understand trends, outliers, and patterns in data.</p>
                    
                    <h3 class="text-xl font-medium text-white mt-6 mb-3">Key Concepts</h3>
                    <ul class="list-disc list-inside space-y-2">
                        <li>Choosing the right visualization type for your data</li>
                        <li>Color theory and accessibility in data visualization</li>
                        <li>Best practices for clear and effective charts</li>
                        <li>Common pitfalls to avoid</li>
                    </ul>
                </div>
                
                <!-- Navigation -->
                <div class="flex flex-col sm:flex-row justify-between gap-3 sm:gap-0 mt-6 sm:mt-10 pt-4 sm:pt-6 border-t border-white/10">
                    <button class="px-4 sm:px-6 py-2 sm:py-3 border border-white/10 rounded-xl text-white hover:bg-[#254346]/50 transition text-sm sm:text-base">
                        <i class="fas fa-arrow-left mr-2"></i>Previous Lesson
                    </button>
                    <button class="px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-[#00655F] to-[#82C293] text-white rounded-xl font-medium hover:opacity-90 transition text-sm sm:text-base">
                        Mark Complete
                        <i class="fas fa-check ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right: AI Tutor (Mobile: Show below content) -->
    <aside class="block xl:block w-full xl:w-96 bg-[#04363a]/90 backdrop-blur-xl xl:border-l border-t xl:border-t-0 border-white/10 shrink-0">
        <div class="p-4 sm:p-6 h-auto xl:h-full flex flex-col xl:min-h-0 max-h-[400px] xl:max-h-none overflow-y-auto">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-xl bg-[#82C293]/20 border border-[#82C293]/30 grid place-items-center">
                        <i class="fas fa-robot text-[#82C293]"></i>
                    </div>
                    <div>
                        <div class="font-medium text-white">Fluentory Tutor</div>
                        <div class="text-xs text-white/60">Context-aware â€¢ Lesson-based</div>
                    </div>
                </div>
            </div>
            
            <div id="tutor-messages" class="flex-1 space-y-4 mb-6 overflow-y-auto">
                {% if tutor_messages %}
                    {% for msg in tutor_messages %}
                        {% if msg.role == 'user' %}
                            <div class="flex justify-end">
                                <div class="max-w-[80%] rounded-2xl bg-[#254346]/70 border border-white/10 px-4 py-3 text-sm text-white">
                                    {{ msg.content }}
                                </div>
                            </div>
                        {% elif msg.role == 'assistant' %}
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-lg bg-[#82C293]/20 border border-[#82C293]/30 grid place-items-center shrink-0">
                                    <i class="fas fa-sparkles text-[#82C293] text-xs"></i>
                                </div>
                                <div class="max-w-[80%] rounded-2xl bg-[#254346]/70 border border-white/10 px-4 py-3 text-sm text-white">
                                    {{ msg.content }}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-lg bg-[#82C293]/20 border border-[#82C293]/30 grid place-items-center shrink-0">
                            <i class="fas fa-robot text-[#82C293] text-xs"></i>
                        </div>
                        <div class="max-w-[80%] rounded-2xl bg-[#254346]/70 border border-white/10 px-4 py-3 text-sm text-white">
                            Hello! I'm your AI tutor. How can I help you with this lesson?
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <div class="space-y-2 mb-4">
                <div class="text-xs uppercase tracking-wider text-white/60 mb-2">Suggested prompts</div>
                <button class="suggested-prompt w-full text-left px-4 py-2 rounded-lg bg-[#254346]/50 border border-white/10 text-sm text-white hover:bg-[#254346]/70 transition" data-prompt="Explain this in simple terms">
                    Explain this in simple terms
                </button>
                <button class="suggested-prompt w-full text-left px-4 py-2 rounded-lg bg-[#254346]/50 border border-white/10 text-sm text-white hover:bg-[#254346]/70 transition" data-prompt="Give me examples">
                    Give me examples
                </button>
                <button class="suggested-prompt w-full text-left px-4 py-2 rounded-lg bg-[#254346]/50 border border-white/10 text-sm text-white hover:bg-[#254346]/70 transition" data-prompt="Quiz me on this lesson">
                    Quiz me on this lesson
                </button>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="tutor-input" placeholder="Ask about this lesson..." class="flex-1 px-4 py-2 rounded-lg border border-white/10 bg-[#254346]/70 text-white placeholder:text-white/50 text-sm focus:outline-none focus:ring-2 focus:ring-[#82C293]/40">
                <button id="tutor-send" class="px-4 py-2 bg-gradient-to-r from-[#00655F] to-[#82C293] text-white rounded-lg hover:opacity-90 transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="mt-3 text-xs text-white/60 text-center">
                <i class="fas fa-info-circle mr-1"></i>
                Based on this lesson
            </div>
        </div>
    </aside>
</div>

{% csrf_token %}
<script>
(function() {
    const tutorInput = document.getElementById('tutor-input');
    const tutorSend = document.getElementById('tutor-send');
    const tutorMessages = document.getElementById('tutor-messages');
    const suggestedPrompts = document.querySelectorAll('.suggested-prompt');
    
    let conversationId = {% if conversation_id %}{{ conversation_id }}{% else %}null{% endif %};
    const lessonId = {% if current_lesson %}{{ current_lesson.id }}{% else %}null{% endif %};
    
    // Add message to chat
    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'flex justify-end' : 'flex items-start gap-3';
        
        if (isUser) {
            messageDiv.innerHTML = `
                <div class="max-w-[80%] rounded-2xl bg-[#254346]/70 border border-white/10 px-4 py-3 text-sm text-white">
                    ${escapeHtml(content)}
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-[#82C293]/20 border border-[#82C293]/30 grid place-items-center shrink-0">
                    <i class="fas fa-sparkles text-[#82C293] text-xs"></i>
                </div>
                <div class="max-w-[80%] rounded-2xl bg-[#254346]/70 border border-white/10 px-4 py-3 text-sm text-white">
                    ${escapeHtml(content)}
                </div>
            `;
        }
        
        tutorMessages.appendChild(messageDiv);
        tutorMessages.scrollTop = tutorMessages.scrollHeight;
    }
    
    // Show loading indicator
    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'tutor-loading';
        loadingDiv.className = 'flex items-start gap-3';
        loadingDiv.innerHTML = `
            <div class="w-8 h-8 rounded-lg bg-[#82C293]/20 border border-[#82C293]/30 grid place-items-center shrink-0">
                <i class="fas fa-sparkles text-[#82C293] text-xs"></i>
            </div>
            <div class="max-w-[80%] rounded-2xl bg-[#254346]/70 border border-white/10 px-4 py-3 text-sm text-white">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-[#82C293] animate-pulse"></div>
                    <div class="w-2 h-2 rounded-full bg-[#82C293] animate-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 rounded-full bg-[#82C293] animate-pulse" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        `;
        tutorMessages.appendChild(loadingDiv);
        tutorMessages.scrollTop = tutorMessages.scrollHeight;
    }
    
    // Remove loading indicator
    function removeLoading() {
        const loading = document.getElementById('tutor-loading');
        if (loading) loading.remove();
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Send message to AI tutor
    async function sendMessage(message) {
        if (!message.trim()) return;
        
        // Add user message to UI
        addMessage(message, true);
        tutorInput.value = '';
        
        // Show loading
        showLoading();
        
        // Disable input while processing
        tutorInput.disabled = true;
        tutorSend.disabled = true;
        
        try {
            const response = await fetch('{% url "ai_tutor_chat" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: message,
                    lesson_id: lessonId || null,
                    conversation_id: conversationId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update conversation ID
                conversationId = data.conversation_id;
                
                // Remove loading and add AI response
                removeLoading();
                addMessage(data.response, false);
            } else {
                removeLoading();
                addMessage('Sorry, I encountered an error. Please try again.', false);
            }
        } catch (error) {
            console.error('Error:', error);
            removeLoading();
            addMessage('Sorry, I\'m having trouble connecting right now. Please try again in a moment.', false);
        } finally {
            // Re-enable input
            tutorInput.disabled = false;
            tutorSend.disabled = false;
            tutorInput.focus();
        }
    }
    
    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Send button click
    if (tutorSend) {
        tutorSend.addEventListener('click', function() {
            const message = tutorInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        });
    }
    
    // Enter key to send
    if (tutorInput) {
        tutorInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = tutorInput.value.trim();
                if (message) {
                    sendMessage(message);
                }
            }
        });
        
        // Enable send button when typing
        tutorInput.addEventListener('input', function() {
            tutorSend.disabled = !tutorInput.value.trim();
        });
    }
    
    // Suggested prompt buttons
    suggestedPrompts.forEach(button => {
        button.addEventListener('click', function() {
            const prompt = this.dataset.prompt;
            if (prompt) {
                tutorInput.value = prompt;
                sendMessage(prompt);
            }
        });
    });
    
    // Focus input on load
    if (tutorInput) {
        tutorInput.focus();
    }
})();
</script>
{% endblock %}

