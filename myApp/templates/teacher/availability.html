{% extends 'teacher/base.html' %}

{% block content %}
<div class="space-y-6 sm:space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">Availability Schedule</h1>
            <p class="text-white/60">Manage your available time slots for live sessions</p>
        </div>
        <a href="{% url 'teacher_schedule_calendar' %}" class="inline-flex items-center gap-2 bg-[#254346] text-white px-5 py-3 rounded-lg hover:bg-[#82C293]/20 transition font-medium border border-white/10">
            <i class="fas fa-calendar"></i>
            Calendar View
        </a>
    </div>
    
    <!-- Add Availability Form -->
    <div class="bg-[#04363a]/50 backdrop-blur-sm border border-white/10 rounded-xl p-6 sm:p-8 shadow-lg">
        <h2 class="text-xl sm:text-2xl font-bold text-white mb-6 flex items-center gap-2">
            <i class="fas fa-plus-circle text-[#82C293]"></i>
            Add Availability Slot
        </h2>
        <form method="post" class="space-y-5">
            {% csrf_token %}
            
            <!-- Slot Type -->
            <div>
                <label class="block mb-2 text-white font-medium">Slot Type <span class="text-red-500">*</span></label>
                <select name="slot_type" id="slot_type" required class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                    <option value="recurring" class="bg-[#254346]">Recurring (Weekly)</option>
                    <option value="one_time" class="bg-[#254346]">One-Time Slot</option>
                </select>
            </div>
            
            <!-- Recurring Slot Fields -->
            <div id="recurring_fields">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block mb-2 text-white font-medium">Day of Week <span class="text-red-500">*</span></label>
                        <select name="day_of_week" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                            <option value="0" class="bg-[#254346]">Monday</option>
                            <option value="1" class="bg-[#254346]">Tuesday</option>
                            <option value="2" class="bg-[#254346]">Wednesday</option>
                            <option value="3" class="bg-[#254346]">Thursday</option>
                            <option value="4" class="bg-[#254346]">Friday</option>
                            <option value="5" class="bg-[#254346]">Saturday</option>
                            <option value="6" class="bg-[#254346]">Sunday</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-2 text-white font-medium">Start Time <span class="text-red-500">*</span></label>
                        <input type="time" name="start_time" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                    </div>
                    <div>
                        <label class="block mb-2 text-white font-medium">End Time <span class="text-red-500">*</span></label>
                        <input type="time" name="end_time" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block mb-2 text-white font-medium">Valid From</label>
                        <input type="date" name="valid_from" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                    </div>
                    <div>
                        <label class="block mb-2 text-white font-medium">Valid Until</label>
                        <input type="date" name="valid_until" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                    </div>
                </div>
            </div>
            
            <!-- One-Time Slot Fields -->
            <div id="one_time_fields" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-2 text-white font-medium">Start Date & Time <span class="text-red-500">*</span></label>
                        <input type="datetime-local" name="start_datetime" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                    </div>
                    <div>
                        <label class="block mb-2 text-white font-medium">End Date & Time <span class="text-red-500">*</span></label>
                        <input type="datetime-local" name="end_datetime" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                    </div>
                </div>
            </div>
            
            <!-- Common Fields -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block mb-2 text-white font-medium">Course (Optional)</label>
                    <select name="course" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                        <option value="" class="bg-[#254346]">All Courses</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}" class="bg-[#254346]">{{ course.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block mb-2 text-white font-medium">Timezone <span class="text-red-500">*</span></label>
                    <select name="timezone" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50">
                        <option value="UTC" class="bg-[#254346]">UTC</option>
                        <option value="America/New_York" class="bg-[#254346]">Eastern Time (ET)</option>
                        <option value="America/Chicago" class="bg-[#254346]">Central Time (CT)</option>
                        <option value="America/Denver" class="bg-[#254346]">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles" class="bg-[#254346]">Pacific Time (PT)</option>
                        <option value="Europe/London" class="bg-[#254346]">London (GMT)</option>
                        <option value="Europe/Paris" class="bg-[#254346]">Paris (CET)</option>
                        <option value="Asia/Dubai" class="bg-[#254346]">Dubai (GST)</option>
                        <option value="Asia/Riyadh" class="bg-[#254346]">Riyadh (AST)</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="w-full sm:w-auto bg-gradient-to-r from-[#00655F] to-[#82C293] text-white px-6 py-3 rounded-lg hover:opacity-90 transition font-medium">
                <i class="fas fa-plus mr-2"></i>Add Availability Slot
            </button>
        </form>
    </div>
    
    <!-- Existing Availability Slots -->
    <div class="bg-[#04363a]/50 backdrop-blur-sm border border-white/10 rounded-xl p-6 sm:p-8 shadow-lg">
        <h2 class="text-xl sm:text-2xl font-bold text-white mb-6 flex items-center gap-2">
            <i class="fas fa-list text-[#82C293]"></i>
            Your Availability Slots
        </h2>
        
        {% if availability_slots %}
        <div class="space-y-4">
            {% for slot in availability_slots %}
            <div class="bg-[#254346]/50 border border-white/10 rounded-lg p-4 {% if not slot.is_active %}opacity-50{% endif %} {% if slot.is_blocked %}border-red-500/50{% endif %}">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-semibold text-white">
                                {% if slot.slot_type == 'one_time' %}
                                    One-Time: {{ slot.start_datetime|date:"M d, Y H:i" }} - {{ slot.end_datetime|date:"H:i" }}
                                {% else %}
                                    {{ slot.get_day_of_week_display }}: {{ slot.start_time|time:"H:i" }} - {{ slot.end_time|time:"H:i" }}
                                {% endif %}
                            </h3>
                            {% if slot.is_blocked %}
                            <span class="px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400 border border-red-500/30">
                                <i class="fas fa-ban mr-1"></i>Blocked
                            </span>
                            {% elif not slot.is_active %}
                            <span class="px-2 py-1 text-xs font-medium rounded bg-gray-500/20 text-gray-400 border border-gray-500/30">
                                Inactive
                            </span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-medium rounded bg-green-500/20 text-green-400 border border-green-500/30">
                                Active
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex flex-wrap items-center gap-4 text-sm text-white/60">
                            <span><i class="fas fa-clock mr-1"></i>{{ slot.timezone }}</span>
                            {% if slot.course %}
                            <span><i class="fas fa-book mr-1"></i>{{ slot.course.title }}</span>
                            {% else %}
                            <span><i class="fas fa-book mr-1"></i>All Courses</span>
                            {% endif %}
                            {% if slot.valid_from %}
                            <span><i class="fas fa-calendar mr-1"></i>From {{ slot.valid_from|date:"M d, Y" }}</span>
                            {% endif %}
                            {% if slot.valid_until %}
                            <span><i class="fas fa-calendar mr-1"></i>Until {{ slot.valid_until|date:"M d, Y" }}</span>
                            {% endif %}
                        </div>
                        {% if slot.blocked_reason %}
                        <div class="mt-2 text-sm text-red-400">
                            <i class="fas fa-exclamation-triangle mr-1"></i>Blocked: {{ slot.blocked_reason }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex gap-2">
                        <form method="post" action="{% url 'teacher_availability_toggle_block' slot.id %}" class="inline">
                            {% csrf_token %}
                            {% if slot.is_blocked %}
                            <button type="submit" class="px-4 py-2 bg-green-500/20 text-green-400 border border-green-500/30 rounded-lg hover:bg-green-500/30 transition text-sm font-medium">
                                <i class="fas fa-unlock mr-1"></i>Unblock
                            </button>
                            {% else %}
                            <button type="button" onclick="showBlockModal({{ slot.id }})" class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg hover:bg-red-500/30 transition text-sm font-medium">
                                <i class="fas fa-ban mr-1"></i>Block
                            </button>
                            {% endif %}
                        </form>
                        <form method="post" action="{% url 'teacher_availability_delete' slot.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this availability slot?');">
                            {% csrf_token %}
                            <button type="submit" class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg hover:bg-red-500/30 transition text-sm font-medium">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-white/60">
            <i class="fas fa-calendar-times text-4xl mb-4 opacity-50"></i>
            <p>No availability slots created yet. Add one above to get started!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Block Modal -->
<div id="blockModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-[#04363a] border border-white/10 rounded-xl p-6 max-w-md w-full">
        <h3 class="text-xl font-bold text-white mb-4">Block Availability Slot</h3>
        <form id="blockForm" method="post" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block mb-2 text-white font-medium">Reason (Optional)</label>
                <textarea name="blocked_reason" rows="3" class="w-full bg-[#254346] border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-[#82C293]/50 focus:border-[#82C293]/50" placeholder="Enter reason for blocking this slot..."></textarea>
            </div>
            <div class="flex gap-3">
                <button type="submit" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition font-medium">
                    Block Slot
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-[#254346] text-white px-4 py-2 rounded-lg hover:bg-[#82C293]/20 transition font-medium border border-white/10">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Toggle between recurring and one-time fields
document.getElementById('slot_type').addEventListener('change', function() {
    const slotType = this.value;
    const recurringFields = document.getElementById('recurring_fields');
    const oneTimeFields = document.getElementById('one_time_fields');
    
    if (slotType === 'recurring') {
        recurringFields.style.display = 'block';
        oneTimeFields.style.display = 'none';
    } else {
        recurringFields.style.display = 'none';
        oneTimeFields.style.display = 'block';
    }
});

// Block modal functions
function showBlockModal(slotId) {
    const form = document.getElementById('blockForm');
    form.action = `/teacher/availability/${slotId}/toggle-block/`;
    document.getElementById('blockModal').classList.remove('hidden');
}

function closeBlockModal() {
    document.getElementById('blockModal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('blockModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBlockModal();
    }
});
</script>
{% endblock %}

