{% extends 'teacher/base.html' %}

{% block content %}
<div class="space-y-8 sm:space-y-10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-10">
        <div>
            <h1 class="text-4xl sm:text-5xl font-bold mb-3 tracking-tight" style="color: var(--text-primary); font-weight: 700;">Availability Schedule</h1>
            <p class="text-base sm:text-lg font-normal tracking-wide" style="color: var(--text-secondary);">Manage your available time slots for live sessions</p>
        </div>
        <a href="{% url 'teacher_schedule_calendar' %}" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl transition-all duration-300 font-medium" style="background: linear-gradient(to right, var(--accent-cta), var(--accent-primary)); color: white; box-shadow: 0 4px 14px rgba(0, 101, 95, 0.25); border: 1px solid rgba(130, 194, 147, 0.25);" onmouseover="this.style.boxShadow='0 8px 24px rgba(0, 101, 95, 0.35)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 4px 14px rgba(0, 101, 95, 0.25)'; this.style.transform='translateY(0)'">
            <i class="fas fa-calendar"></i>
            Calendar View
        </a>
    </div>
    <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent mb-8"></div>
    
    <!-- Add Availability Form -->
    <div class="bg-white/5 backdrop-blur-2xl border border-white/8 rounded-2xl p-8 sm:p-10 shadow-xl">
        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white mb-8 tracking-tight flex items-center gap-3">
            <i class="fas fa-plus-circle text-emerald-600 dark:text-emerald-400 text-xl"></i>
            Add Availability Slot
        </h2>
        <form method="post" class="space-y-5">
            {% csrf_token %}
            
            <!-- Slot Type -->
            <div>
                <label class="block mb-2 text-slate-800 dark:text-white font-medium">Slot Type <span class="text-red-500">*</span></label>
                <select name="slot_type" id="slot_type" required class="form-select">
                    <option value="recurring">Recurring (Weekly)</option>
                    <option value="one_time">One-Time Slot</option>
                </select>
            </div>
            
            <!-- Recurring Slot Fields -->
            <div id="recurring_fields">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Day of Week <span class="text-red-500">*</span></label>
                        <select name="day_of_week" class="form-select">
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Start Time <span class="text-red-500">*</span></label>
                        <input type="time" name="start_time" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">End Time <span class="text-red-500">*</span></label>
                        <input type="time" name="end_time" class="form-input">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="form-label">Valid From</label>
                        <input type="date" name="valid_from" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Valid Until</label>
                        <input type="date" name="valid_until" class="form-input">
                    </div>
                </div>
            </div>
            
            <!-- One-Time Slot Fields -->
            <div id="one_time_fields" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Start Date & Time <span class="text-red-500">*</span></label>
                        <input type="datetime-local" name="start_datetime" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">End Date & Time <span class="text-red-500">*</span></label>
                        <input type="datetime-local" name="end_datetime" class="form-input">
                    </div>
                </div>
            </div>
            
            <!-- Common Fields -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="form-label">Course (Optional)</label>
                    <select name="course" class="form-select">
                        <option value="">All Courses</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="form-label">Timezone <span class="text-red-500">*</span></label>
                    <select name="timezone" class="form-select">
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="Europe/London">London (GMT)</option>
                        <option value="Europe/Paris">Paris (CET)</option>
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="Asia/Riyadh">Riyadh (AST)</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="w-full sm:w-auto bg-gradient-to-r from-[#82C293] via-[#6fb380] to-[#82C293] text-white px-6 py-3 rounded-xl font-semibold shadow-lg shadow-[#82C293]/30 hover:shadow-xl hover:shadow-[#82C293]/40 hover:scale-105 transition-all duration-300">
                <i class="fas fa-plus mr-2"></i>Add Availability Slot
            </button>
        </form>
    </div>
    
    <!-- Existing Availability Slots -->
    <div class="bg-white/5 backdrop-blur-2xl border border-white/8 rounded-2xl p-8 sm:p-10 shadow-xl">
        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white mb-8 tracking-tight flex items-center gap-3">
            <i class="fas fa-list text-emerald-600 dark:text-emerald-400 text-xl"></i>
            Your Availability Slots
        </h2>
        
        {% if availability_slots %}
        <div class="space-y-4">
            {% for slot in availability_slots %}
            <div class="bg-white/3 border border-white/10 rounded-xl p-5 hover:bg-white/8 hover:border-[#82C293]/20 transition-all duration-300 {% if not slot.is_active %}opacity-50{% endif %} {% if slot.is_blocked %}border-red-500/50{% endif %}">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
                                {% if slot.slot_type == 'one_time' %}
                                    One-Time: {{ slot.start_datetime|date:"M d, Y H:i" }} - {{ slot.end_datetime|date:"H:i" }}
                                {% else %}
                                    {{ slot.get_day_of_week_display }}: {{ slot.start_time|time:"H:i" }} - {{ slot.end_time|time:"H:i" }}
                                {% endif %}
                            </h3>
                            {% if slot.is_blocked %}
                            <span class="px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400 border border-red-500/30">
                                <i class="fas fa-ban mr-1"></i>Blocked
                            </span>
                            {% elif not slot.is_active %}
                            <span class="px-2 py-1 text-xs font-medium rounded bg-gray-500/20 text-gray-400 border border-gray-500/30">
                                Inactive
                            </span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-medium rounded bg-green-500/20 text-green-400 border border-green-500/30">
                                Active
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 dark:text-slate-300/80">
                            <span><i class="fas fa-clock mr-1"></i>{{ slot.timezone }}</span>
                            {% if slot.course %}
                            <span><i class="fas fa-book mr-1"></i>{{ slot.course.title }}</span>
                            {% else %}
                            <span><i class="fas fa-book mr-1"></i>All Courses</span>
                            {% endif %}
                            {% if slot.valid_from %}
                            <span><i class="fas fa-calendar mr-1"></i>From {{ slot.valid_from|date:"M d, Y" }}</span>
                            {% endif %}
                            {% if slot.valid_until %}
                            <span><i class="fas fa-calendar mr-1"></i>Until {{ slot.valid_until|date:"M d, Y" }}</span>
                            {% endif %}
                        </div>
                        {% if slot.blocked_reason %}
                        <div class="mt-2 text-sm text-red-400">
                            <i class="fas fa-exclamation-triangle mr-1"></i>Blocked: {{ slot.blocked_reason }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex gap-2">
                        <form method="post" action="{% url 'teacher_availability_toggle_block' slot.id %}" class="inline">
                            {% csrf_token %}
                            {% if slot.is_blocked %}
                            <button type="submit" class="px-4 py-2 bg-green-500/20 text-green-400 border border-green-500/30 rounded-lg hover:bg-green-500/30 transition text-sm font-medium">
                                <i class="fas fa-unlock mr-1"></i>Unblock
                            </button>
                            {% else %}
                            <button type="button" onclick="showBlockModal({{ slot.id }})" class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg hover:bg-red-500/30 transition text-sm font-medium">
                                <i class="fas fa-ban mr-1"></i>Block
                            </button>
                            {% endif %}
                        </form>
                        <form method="post" action="{% url 'teacher_availability_delete' slot.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this availability slot?');">
                            {% csrf_token %}
                            <button type="submit" class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg hover:bg-red-500/30 transition text-sm font-medium">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-calendar-times text-5xl text-slate-400 dark:text-slate-500 mb-4"></i>
            <p class="text-slate-600 dark:text-slate-300/80 mb-1 text-base">No availability slots created yet</p>
            <p class="text-sm text-slate-600 dark:text-slate-400">Add one above to get started!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Block Modal -->
<div id="blockModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white/5 backdrop-blur-2xl border border-white/10 rounded-2xl p-6 max-w-md w-full shadow-xl">
        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Block Availability Slot</h3>
        <form id="blockForm" method="post" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="form-label">Reason (Optional)</label>
                <textarea name="blocked_reason" rows="3" class="form-textarea" placeholder="Enter reason for blocking this slot..."></textarea>
            </div>
            <div class="flex gap-3">
                <button type="submit" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition font-medium">
                    Block Slot
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-[#254346] text-white px-4 py-2 rounded-lg hover:bg-[#82C293]/20 transition font-medium border border-white/10">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Toggle between recurring and one-time fields
document.getElementById('slot_type').addEventListener('change', function() {
    const slotType = this.value;
    const recurringFields = document.getElementById('recurring_fields');
    const oneTimeFields = document.getElementById('one_time_fields');
    
    if (slotType === 'recurring') {
        recurringFields.style.display = 'block';
        oneTimeFields.style.display = 'none';
    } else {
        recurringFields.style.display = 'none';
        oneTimeFields.style.display = 'block';
    }
});

// Block modal functions
function showBlockModal(slotId) {
    const form = document.getElementById('blockForm');
    form.action = `/teacher/availability/${slotId}/toggle-block/`;
    document.getElementById('blockModal').classList.remove('hidden');
}

function closeBlockModal() {
    document.getElementById('blockModal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('blockModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBlockModal();
    }
});
</script>
{% endblock %}

